BX.namespace("BX.Sale.OrderAjaxComponent.Maps");
(function(){BX.Sale.OrderAjaxComponent.Maps={init:function(a){this.context=a||{};this.pickUpOptions=this.context.options.pickUpMap;this.propsOptions=this.context.options.propertyMap;this.maxWaitTimeExpired=!1;return this},initializePickUpMap:function(a){ymaps&&(this.pickUpMap=new ymaps.Map("pickUpMap",{center:a?[a.GPS_N,a.GPS_S]:[this.pickUpOptions.defaultMapPosition.lat,this.pickUpOptions.defaultMapPosition.lon],zoom:this.pickUpOptions.defaultMapPosition.zoom,controls:[]}),this.pickUpMap.events.add("click",
BX.delegate(function(){this.pickUpMap.balloon.isOpen()&&this.pickUpMap.balloon.close()},this)))},pickUpMapFocusWaiter:function(){this.pickUpMap&&this.pickUpMap.geoObjects?this.setPickUpMapFocus():setTimeout(BX.proxy(this.pickUpMapFocusWaiter,this),100)},setPickUpMapFocus:function(){var a;if((a=this.pickUpMap.geoObjects.getBounds())&&a.length){var b=a[1][0]-a[0][0];var c=a[1][1]-a[0][1];a[0][0]-=b/10;a[0][1]-=c/10;a[1][0]+=b/10;a[1][1]+=c/10;this.pickUpMap.setBounds(a,{checkZoomRange:!0})}},showNearestPickups:function(a,
b){if(ymaps){var c=this.pickUpOptions.secureGeoLocation&&BX.browser.IsChrome()&&!this.context.isHttps?"yandex":"auto";ymaps.geolocation.get({provider:c,timeOut:this.pickUpOptions.geoLocationMaxTime||5E3}).then(BX.delegate(function(e){this.maxWaitTimeExpired||(this.maxWaitTimeExpired=!0,e.geoObjects.options.set("preset","islands#darkGreenCircleDotIcon"),this.pickUpMap.geoObjects.add(e.geoObjects),a(e))},this),BX.delegate(function(){this.maxWaitTimeExpired||(this.maxWaitTimeExpired=!0,b())},this))}},
buildBalloons:function(a){if(ymaps){var b=this;this.pickUpPointsJSON=[];for(var c=0;c<a.length;c++){var e=this.getStoreInfoHtml(a[c]);this.pickUpPointsJSON.push({type:"Feature",geometry:{type:"Point",coordinates:[a[c].GPS_N,a[c].GPS_S]},properties:{storeId:a[c].ID}});e=new ymaps.Placemark([a[c].GPS_N,a[c].GPS_S],{hintContent:BX.util.htmlspecialchars(a[c].TITLE),storeTitle:a[c].TITLE,storeBody:e,id:a[c].ID,text:this.context.params.MESS_SELECT_PICKUP},{balloonOffset:[40,40],balloonContentLayout:ymaps.templateLayoutFactory.createClass('<div class="popover top"><a class="close" href="javascript:void(0)" onclick="BX.Sale.OrderAjaxComponent.Maps.closeBaloon(this);return false;" data-close="Y"><img src="/local/templates/audiotech/images/icns/md-x.svg"></a><div class="arrow"></div><div class="popover-inner"><h3 class="popover-title">{{ properties.storeTitle }}</h3><div class="popover-content">{{ properties.storeBody|raw }}</div></div></div>',
{build:function(){this.constructor.superclass.build.call(this);let d=document.querySelector("a[data-store]");d&&BX.bind(d,"click",this.selectStoreByClick)},clear:function(){var d=document.querySelector("a[data-store]");d&&BX.unbind(d,"click",this.selectStoreByClick);this.constructor.superclass.clear.call(this)},selectStoreByClick:function(d){var f=d.target||d.srcElement;b.pickUpMap.container.isFullscreen()&&b.pickUpMap.container.exitFullscreen();b.context.selectStore(f.getAttribute("data-store"));
b.context.clickNextAction(d);b.pickUpMap.balloon.close()},onCloseClick:function(d){d.preventDefault();this.events.fire("userclose")}}),hideIconOnBalloonOpen:!1,iconLayout:"default#image",iconImageHref:"/local/templates/audiotech/images/icns/sm-location-marker.svg",iconImageSize:[32,32],iconImageOffset:[-5,-38]});this.pickUpMap.geoObjects.add(e)}}},selectBalloon:function(a){this.pickUpMap&&this.pickUpMap.geoObjects&&this.pickUpMap.geoObjects.each(BX.delegate(function(b){b.properties.get("id")&&b.options.unset("preset");
b.properties.get("id")===a&&(b.options.set({preset:"islands#redDotIcon"}),this.pickUpMap.panTo([b.geometry.getCoordinates()]))},this))},pickUpFinalAction:function(){if(this.pickUpMap&&this.pickUpMap.geoObjects){var a=BX("BUYER_STORE");this.pickUpMap.geoObjects.each(function(b){b.properties.get("id")===a.value?b.options.set({preset:"islands#redDotIcon"}):0<parseInt(b.properties.get("id"))&&b.options.unset("preset")})}},initializePropsMap:function(a){ymaps&&(this.propsMap=new ymaps.Map("propsMap",{center:[a.lat,
a.lon],zoom:a.zoom}),this.propsMap.behaviors.disable("scrollZoom"),this.propsMap.events.add("click",BX.delegate(function(b){b=b.get("coords");if(0===this.propsMap.geoObjects.getLength()){var c=new ymaps.Placemark([b[0],b[1]],{},{draggable:!0,preset:"islands#redDotIcon"});c.events.add(["parentchange","geometrychange"],function(){var e=BX("orderDescription"),d=c.geometry.getCoordinates();if(e){var f=e.value.indexOf(BX.message("SOA_MAP_COORDS")+":");if(-1===f)e.value=BX.message("SOA_MAP_COORDS")+": "+
d[0]+", "+d[1]+"\r\n"+e.value;else{var g=BX.message("SOA_MAP_COORDS")+": "+d[0]+", "+d[1];d=e.value.substring(0,f);f=e.value.substring(f+g.length);e.value=d+g+f}}});this.propsMap.geoObjects.add(c)}else this.propsMap.geoObjects.get(0).geometry.setCoordinates([b[0],b[1]])},this)))},canUseRecommendList:function(){return this.pickUpPointsJSON&&this.pickUpPointsJSON.length},getRecommendedStoreIds:function(a){if(!a)return[];var b=[],c=this.pickUpPointsJSON.length<this.pickUpOptions.nearestPickUpsToShow?
this.pickUpPointsJSON.length:this.pickUpOptions.nearestPickUpsToShow;this.storeQueryResult={};for(var e=0;e<c;e++){var d=ymaps.geoQuery({type:"FeatureCollection",features:this.pickUpPointsJSON}),f=d.getClosestTo(a),g=f.properties.get("storeId");this.storeQueryResult[g]=f;b.push(g);this.pickUpPointsJSON.splice(d.indexOf(f),1)}return b},getDistance:function(a,b){if(!a||!b)return!1;b=this.storeQueryResult[b];a=ymaps.coordSystem.geo.getDistance(a.geometry.getCoordinates(),b.geometry.getCoordinates());
return a=Math.round(a/100)/10},propsMapFocusWaiter:function(){},getStoreInfoHtml:function(a){var b="<ul>";a.ADDRESS&&(b+=`<li><span>${BX.message("SOA_PICKUP_ADDRESS")}</span><span>${BX.util.htmlspecialchars(a.ADDRESS)}</span></li>`);a.SCHEDULE&&(b+=`<li><span>${BX.message("SOA_PICKUP_WORK")}</span><span>${a.SCHEDULE}</span></li>`);a.PHONE&&(b+=`<li><span>${BX.message("SOA_PICKUP_PHONE")}</span><span>${BX.util.htmlspecialchars(a.PHONE)}</span></li>`);a.EMAIL&&(b+=`<li><span>${BX.message("SOA_PICKUP_DESC")}</span><span>${BX.util.htmlspecialchars(a.DESCRIPTION)}</span></li>`);
return b+"</ul>"},closeBaloon:function(){let a=document.querySelector('[class*="balloon__close-button"]');a&&a.click()}}})();
